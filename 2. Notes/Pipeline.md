本文基于《计算机体系结构：量化研究方法（第六版）》附录C
## 流水线
一种将多条指令重叠执行的实现技术
# RSIC流水线
## RSIC指令集
- RSIC指令集每条指令都可以在最多五个时钟周期内实现。
- 其中，分支指令需要3个周期，存储指令需要4个周期，所有其他指令需要5个周期。
### 取指令周期IF
- 将程序计数器（PC）发送到存储器，从存储器提取当前指令。将PC+4，因为每条指令长度为4 bytes。PC更新到下一条顺序指令。
### 指令译码/读寄存器周期ID
- 对指令进行译码，并从寄存器堆中读取与寄存器源说明符相对应的寄存器。
- 指令译码与寄存器的读取是并行执行的，因为RSIC体系结构中，寄存器说明符位于固定位置。
### 执行/有效地址周期EX
- ALU对上一周期中准备的操作数进行操作。
	- 存储器访问：ALU将基地址寄存器和偏移量加在一起，形成有效地址。
	- 寄存器-寄存器ALU指令：ALU对从寄存器堆读取的值执行由ALU操作码指定的操作。
	- 寄存器-立即数ALU指令：ALU对从寄存器堆读取的第一个值和符号扩展立即数执行ALU opcode指定的操作
	- 条件分支：判断条件是否为真
### 存储器访问MEM
- 如果该指令是一条load指令，则使用上一周期中计算的有效地址从存储器中读取数据。
- 如果是一条存储指令，则使用有效地址将从寄存器堆的第二个寄存器读取的数据写入存储器。
### 写回指令周期WB
- 将结果写入寄存器，无论结果来自存储系统（对于load指令），还是来自ALU（对于ALU指令）。
## RSIC处理器的经典五级流水
![[Pasted image 20221222191311.png]]
### 多条指令不会引起冲突的原因
- 分离的指令存储器和数据存储器，用分离的Cache实现。
- 在ID和WB阶段都要使用寄存器堆，所以在时钟周期前半部分写寄存器，后半部分读寄存器。
- PC+4在IF阶段完成。需要一个加法器在ID阶段计算潜在分支目标，ALU阶段评估分支条件。
为了保证不同流水级之间的指令不会相互影响，所以需要在连续的流水级之间引入**流水线寄存器**
![[Pasted image 20221222192001.png]]
## 流水化的基本性能问题
- 流水化提高了处理器指令的**吞吐量**（单位时间内完成的指令数），但不会缩短单条指令的执行时间。
- 流水化会提高单挑指令时间。
- 流水线开销包括流水线寄存器延迟和时钟偏差（Clock Skew）。
	- 流水线寄存器增加建立时间（Setup Time），也就是发出触发写操作时钟信号之前，寄存器输入必须保持稳定的时间。加上时钟周期的传播延迟就是总延迟。
	- 时钟偏差是时钟到达任意两个寄存器时刻之间的最大延迟。
- 一旦时钟周期与流水线的开销总和一样小，进一步流水化就没有用了。
- 流水化可以使性能提高的倍数等于流水线深度（也称为流水级数目）
# 流水线冒险（Pipeline Hazards）
## 结构冒险（Structural hazards）
- 在重叠执行模式下，如果硬件无法同时支持指令的所有可能组合方式，就会出现资源冒险，进而道尔结构冒险。
## 数据冒险（Data hazards）
- 由于流水线中的指令重叠执行，如果一条指令依赖先前指令的结果，就可能导致数据冒险。
### 写后读（RAW）冒险
- 当前一个指令还没有写回到寄存器时，后一个指令已经读取就会发生冒险。
#### 消除RAW冒险
- 通过重定向（forwarding）或者旁路（bypassing）来解决冲突
- 有些冲突不能通过重定向因为过了时钟周期，所以采用阻塞流水线直到源指令生成数据为止。
### 读后写（WAR）冒险
- 前一个指令的读取发生在后一个指令的写入之后，导致发生冒险
- 一般情况下不会出现。
### 写后写（WAW）冒险
- 当前一个指令的写入发生在后一个指令的写入之后，导致发生冒险。
- 一般情况下不会发生。
## 控制冒险（Control hazards）
- 分支指令及其他改变程序计数器的指令实现流水化时可能导致控制冒险。
### 减少分支冲突
- 冻结或冲刷流水线，即保留或删除分支之后的所有指令，直到知道分支目标为止。
- 将每个分支看做未选中分支
- 将所有分支看做选中分支
- 延迟分支
# 分支预测（Branch Prediction）
## 静态分支预测
- 利用先前运行过程中收集的特征数据。
- 任意分支预测机制的有效性都取决于机制的准确率和条件分支的频率。
## 动态分支预测
- 最简单的动态分支预测是分支预测缓存区（branch-prediction buffer）或分支历史表（branch history table）。
- 它是一个小型存储器，根绝分支指令的地位部分进行索引。这个储存器包含一位，表明该分支最近是否曾被选中。
- 经常使用两位预测机制